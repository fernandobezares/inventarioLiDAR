/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var fcc = ee.ImageCollection("users/cesefor/InventarioForestal/LiDAR/1C/FCC"),
    p95 = ee.ImageCollection("users/cesefor/InventarioForestal/LiDAR/1C/P95"),
    mdav = ee.ImageCollection("users/cesefor/InventarioForestal/LiDAR/1C/MDAV");
/***** End of imports. If edited, may not auto-convert in the playground. *****/
// import LiDAR Vars
var lidar = require('users/cesefor/inventarioForestal:LiDARVars');

// aoi list
var provinciasNames = ['Ávila','Burgos','León','Palencia','Salamanca','Segovia','Soria','Valladolid','Zamora'];

// aoi datasets 
var cyl = ee.FeatureCollection('users/cesefor/general/adminUnits/LimiteAdmin_CyL');
var cylStyled = cyl.style({color : 'black' , fillColor:'FF000000'});

// cyl Provinces 
var cylP = ee.FeatureCollection('users/cesefor/general/adminUnits/Provincias_ETRS89').filter(ee.Filter.inList('NAMEUNIT',provinciasNames));
var cylPStyled = cylP.style({color : 'black' , fillColor:'FF000000' , lineType : 'dashed', width: 0.7} );



// cargar las fcc
var fcc = fcc.mosaic();

// cargar la p95
var p95 = p95. mosaic();
var mdav = mdav.map(function(image){return image.updateMask(image.neq(0))}).mosaic();

// visualize vars 
Map.addLayer(fcc,{min:0,max:100,palette:['white','lightyellow','lightgreen','green']},'fcc',0);
Map.addLayer(p95,{min:0,max:25,palette:['white','lightyellow','orange','red']},'p95',0);
Map.addLayer(mdav,{min:0,max:25,palette:['white','lightblue','blue','purple']},'mdav',0);

// visualize provinces
Map.addLayer(cylPStyled,{},'Provincias',0);
Map.addLayer(cylStyled,{},'CYL',0);


//check which cover is selected
function checkCoberturas(cobertura){
  
  // check the value of the select cobertura 
  if (cobertura === null){
    
    alert('Selecciona una cobertura');
  // if cobertura is not null
  } else {
    
    // if cobertura is equal to 1c then retrieve the keys 
    if (cobertura === '1a Cobertura'){
     
      // return the keys of the 1 cover object
      return Object.keys(lidar.c1);
    
  }else if (cobertura === '2a Cobertura'){
    
      // return the keys of the 2 cover object
      return Object.keys(lidar.c2);
    }
  
    
  }
    
}

var visualizations = {
  'fcc': {min:0,max:100,palette:['white','lightyellow','lightgreen','green']},
  'mdav':{min:0,max:25,palette:['white','lightblue','blue','purple']},
  'elev_p95':{min:0,max:25,palette:['white','lightyellow','orange','red']},
}

print(Map.layers())
// function for displaying teh selected image 

function displayImage(image){
  
  // get cover value
  var cobertura = coberturaSelect.getValue()
  cobertura.evaluate(function(cover){
    // clean the active layer list
    
    if (Map.layers().length().gte(0)){
      
      // clear the Map and add the selected layer 
      Map.clear();
      
      // add images
      
      // visualize vars 
      Map.addLayer(lidar[cover][image],visualizations[image],image,1);
      
      
      // visualize provinces
      Map.addLayer(cylPStyled,{},'Provincias',0);
      Map.addLayer(cylStyled,{},'CYL',0);
      
    } else{
      
      // visualize vars 
      Map.addLayer(lidar[cover][image],visualizations[image],image,1);
      
      
      // visualize provinces
      Map.addLayer(cylPStyled,{},'Provincias',0);
      Map.addLayer(cylStyled,{},'CYL',0);
      
    }
  
    
  })
  
    
  
}
  

// 
// ui.Panel
var mainPanel = ui.Panel({layout : ui.Panel.Layout.flow('vertical')});
mainPanel.style().set({width:'300px', margin:"4px"});

// Main Title 
var mainTitle = ui.Label('Visor Variables LiDAR');

// Select area
var aoi = ui.Select({
  items: provinciasNames.concat(['Castilla y León']) ,
  onChange: function(name){
    
    // get the name and check
    if (name === 'Castilla y León'){
      
      
      Map.addLayer(cylStyled,{},'CYL');

      
    } else {
      
      
    }
    
    
  }
});

// cover lists
var cobs = ['1a Cobertura','2a Cobertura'];

// ui.Panel for covers 
var buttonPanels = ui.Panel({layout:ui.Panel.Layout.flow('vertical')});
buttonPanels.style().set({backgroundColor:'#c0b09e',width:'100%'})


// select Dataset from coberturas 
var datasetSelect = ui.Select({
  items: [],
  style: {width: "95%"},
  placeholder:'Datasets'
});

// loading datasets 
var loadingDatasetSelect = ui.Select({
  items: [],
  style: {width: "95%"},
  placeholder:'Loading...'
});



// ui.Select coberturas
var coberturaSelect = ui.Select({
  items: cobs,
  placeholder:'Seleccionar Cobertura LiDAR',
  value: '1a Cobertura',
  style: {width: "95%"},
  onChange:function(cover){
    buttonPanels.clear().add(coberturaSelect).add(loadingDatasetSelect);
    // chechk the  type of LiDR Cover 
    var datasets = checkCoberturas(cover);
    ee.List(datasets).evaluate(function(list){
      //print(list)
        datasetSelect = ui.Select({
          placeholder: 'Variables LiDAR',
          items: list,
          style: {width: "95%"},
          //value: 'All regions'
        });
    buttonPanels.clear().add(coberturaSelect).add(datasetSelect); 
    });
  }
});
      
buttonPanels.clear().add(coberturaSelect).add(datasetSelect);




// add widgets to panel 

mainPanel.add(mainTitle).add(buttonPanels);

ui.root.add(mainPanel);